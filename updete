@app.websocket("/ws/{rid}")
async def ws_room(ws: WebSocket, rid: str):
    await ws.accept()
    room = get_room(rid)

    pid = secrets.token_urlsafe(8)

    try:
        # 첫 메시지 join
        raw = await ws.receive_text()
        data = json.loads(raw)
        if data.get("type") != "join":
            await error(ws, "첫 메시지는 join이어야 합니다.")
            await ws.close()
            return

        name = (data.get("name") or "").strip()[:20]
        if not name:
            await error(ws, "이름이 필요합니다.")
            await ws.close()
            return

        room.players.append(Player(pid=pid, name=name))
        room.sockets[pid] = ws

        await system(room, f"{name} 입장")
        await ws.send_text(json.dumps({"type": "joined", "pid": pid, "rid": rid}, ensure_ascii=False))
        await broadcast(room, state_payload(room))

        while True:
            raw = await ws.receive_text()
            data = json.loads(raw)
            t = data.get("type")

            if t == "start":
                # 누구나 start 가능
                await start_game(room)

            elif t == "submit":
                await handle_submit(room, pid, data.get("word", ""), ws)

            elif t == "ping":
                await ws.send_text(json.dumps({"type": "pong"}, ensure_ascii=False))

            else:
                await error(ws, "알 수 없는 메시지 타입입니다.")

    except WebSocketDisconnect:
        room.sockets.pop(pid, None)
        try:
            p = find_player(room, pid)
            await system(room, f"{p.name} 연결 끊김")
        except Exception:
            pass
